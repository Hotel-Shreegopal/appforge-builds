name: Build APK
on:
  repository_dispatch:
    types: [build-apk]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Flutter
        uses: subosspace/flutter-action@v2
        with:
          flutter-version: 3.22.0
          channel: stable

      - name: Create Flutter project
        run: |
          flutter create --org com.appforge --project-name appforge_app .
          rm -rf lib/main.dart test/

      - name: Write project files
        env:
          PROJECT_FILES: ${{ toJson(github.event.client_payload.project_files) }}
        run: |
          echo "$PROJECT_FILES" > /tmp/files.json
          python3 << 'PYEOF'
          import json, os, pathlib
          with open("/tmp/files.json") as f:
              files = json.load(f)
          for fpath, content in files.items():
              p = pathlib.Path(fpath)
              p.parent.mkdir(parents=True, exist_ok=True)
              p.write_text(content)
              print(f"Written: {fpath}")
          PYEOF

      - name: Get dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release --no-tree-shake-icons 2>&1 || flutter build apk --debug --no-tree-shake-icons

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk-release
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 7
